<!-- ((! set title Building and Publishing an OCaml library !)) ((! set learn !)) -->
<!-- ((! set center !)) -->

# Building and Publishing an OCaml library

In this tutorial, we build a simple OCaml library with the `dune` build system,
test it, and publish it on the `opam` respository of OCaml packages, so it may
be used by anyone.

## Our library and its source files

We will write and publish a library to generate a string in roman numerals of a
given number. Here is the implementation file `roman.ml`:

```ocaml
let roman_vals =
  [(900, "CM"); (500, "D"); (400, "CD"); (100, "C"); (100, "C"); (100, "C");
  (90, "XC"); (50, "L"); (40, "XL"); (10, "X"); (10, "X"); (10, "X");
  (9, "IX"); (5, "V"); (4, "IV"); (1, "I"); (1, "I"); (1, "I")]

let rec roman_recurse b n = function
  | [] -> ()
  | (n', s) :: t ->
      if n >= n' then
        begin
          Buffer.add_string b s;
          roman_recurse b (n - n') t
        end
      else
        roman_recurse b n t

let rec roman b n =
  if n < 1 then ()
  else if n > 999 then
    begin
      for x = 1 to n / 1000 do Buffer.add_char b 'M' done;
      roman b (n mod 1000)
    end
  else
    roman_recurse b n roman_vals

let roman_string_of_int n =
  let b = Buffer.create 32 in
    roman b n;
    Buffer.contents b
```

Here is the interface `roman.mli`

```ocaml
val roman_int_of_string : int -> string
```

## A Github repository for our files

We set up a Github repository, choosing to add a template `README.md`, to add a
standard license, and to add the standard OCaml `.gitignore`. We add our two
source files `roman.ml` and `roman.mli`. We clone the repository on our local
machine, then we have:

```
drwxr-xr-x  13 john  staff   416 14 Apr 16:31 .git
-rw-r--r--   1 john  staff   293 14 Apr 16:25 .gitignore
-rw-r--r--   1 john  staff  1325 14 Apr 16:25 LICENSE
-rw-r--r--   1 john  staff    33 14 Apr 16:25 README.md
-rw-r--r--   1 john  staff   759 14 Apr 16:32 roman.ml
-rw-r--r--   1 john  staff    40 14 Apr 16:32 roman.mli
```

## Setting up dune

We write the following in a file called simply `dune`:

```scheme
(library
  (name roman))
```

Now, we can run `dune build`, which will build the library, and automatically
create another dune file, `dune-project` with default contents:

```
$ dune build
Info: Creating file dune-project with this contents:
| (lang dune 2.8)
```

A quick look shows that dune has built the library in the `_build` directory.
It contains a file `log` which shows the commands chosen by dune to compile the
library, and another directory `default` which contains many things, but
amongst them the compiled files `roman.a`, `roman.cma`, and `roman.cmxa`.

## Testing our program

We create a new directory `example` in our repository, and add the following
`romanexample.ml` to print a selection of interesting roman numerals:

```ocaml
for n = 1 to 50 do
  Printf.printf "%i \t %s\n" (n * 37) (Roman.roman_string_of_int (n * 37))
done
```

Now we put a `dune` file in the `example` directory, giving the name of the
executable and the library it needs:

```scheme
(executable
  (name romanexample)
  (libraries roman))
```

Now we can run `dune exec romanexample.exe` (or `dune exec
example/romanexample.exe` from the parent directory) to build and run our
program:

```
$ dune exec example/romanexample.exe
37       XXXVII      
74       LXXIV
111      CXI
148      CXLVIII
185      CLXXXV
222      CCXXII
259      CCLIX
296      CCXCVI
333      CCCXXXIII
370      CCCLXX
407      CDVII
444      CDXLIV
481      CDLXXXI
518      DXVIII
555      DLV
592      DXCII
629      DCXXIX
666      DCLXVI
703      DCCIII
740      DCCXL
777      DCCLXXVII
814      DCCCXIV
851      DCCCLI
888      DCCCLXXXVIII
925      CMXXV
962      CMLXII
999      CMXCIX
1036     MXXXVI
1073     MLXXIII
1110     MCX
1147     MCXLVII
1184     MCLXXXIV
1221     MCCXXI
1258     MCCLVIII
1295     MCCXCV
1332     MCCCXXXII
1369     MCCCLXIX
1406     MCDVI
1443     MCDXLIII
1480     MCDLXXX
1517     MDXVII
1554     MDLIV
1591     MDXCI
1628     MDCXXVIII
1665     MDCLXV
1702     MDCCII
1739     MDCCXXXIX
1776     MDCCLXXVI
1813     MDCCCXIII
1850     MDCCCL
```

## Building and testing an opam package

Dune can do the work of generating opam descriptions for us. We edit the
`dune-project` file to read:

```scheme
(lang dune 2.8)
(name roman)
(generate_opam_files true)
(source (github johnwhitington/roman))
(license BSD-2-Clause)
(authors "John Whitington")
(maintainers "example@example.org")

(package
   (name roman)
   (synopsis "Manipulate roman numerals"))
```

Now, when we run `dune build`, the file `roman.opam` is generated. Here is its content:

```
# This file is generated by dune, edit dune-project instead
opam-version: "2.0"
synopsis: "Manipulate roman numerals"
maintainer: ["contact@coherentgraphics.co.uk"]
authors: ["John Whitington"]
license: "BSD-2-Clause"
homepage: "https://github.com/johnwhitington/roman"
bug-reports: "https://github.com/johnwhitington/roman/issues"
depends: [
  "dune" {>= "2.8"}
  "odoc" {with-doc}
]
build: [
  ["dune" "subst"] {dev}
  [
    "dune"
    "build"
    "-p"
    name
    "-j"
    jobs
    "@install"
    "@runtest" {with-test}
    "@doc" {with-doc}
  ]
]
dev-repo: "git+https://github.com/johnwhitington/roman.git"
```

Notice that `dune clean` does not remove this new `roman.opam` file. Even
though it is generated, we add it to our git repository. Now we have:

```
drwxr-xr-x  13 john  staff   416 14 Apr 16:56 .git
-rw-r--r--   1 john  staff   293 14 Apr 16:25 .gitignore
-rw-r--r--   1 john  staff  1325 14 Apr 16:25 LICENSE
-rw-r--r--   1 john  staff    33 14 Apr 16:25 README.md
-rw-r--r--   1 john  staff    25 14 Apr 16:30 dune
-rw-r--r--   1 john  staff   262 15 Apr 15:39 dune-project
drwxr-xr-x   4 john  staff   128 14 Apr 18:12 example
    -rw-r--r--  1 john  staff  55 14 Apr 18:07 dune
    -rw-r--r--  1 john  staff  99 14 Apr 18:12 romanexample.ml
-rw-r--r--   1 john  staff   759 14 Apr 16:32 roman.ml
-rw-r--r--   1 john  staff    40 14 Apr 16:32 roman.mli
-rw-r--r--   1 john  staff   612 15 Apr 15:39 roman.opam
```

We can now test installation of the package like this:

```
dune build
opam install .
```

Now we are ready to share our library with the world.

## Publishing to the opam repository

We tag a version of our new libary in the repository, and push it:

```
git tag -a 0.1
git push origin 0.1
```

Now, we can run the `opam publish` command, following the instructions to
publish to opam. Once accepted, other users can now install our package. NB:
You will need to have your ssh keys [registered in your Github
account](https://docs.github.com/en/github/authenticating-to-github/adding-a-new-ssh-key-to-your-github-account)
for this to work. More details about alternative methods of publication can be
found in the [opam packaging guide](https://opam.ocaml.org/doc/Packaging.html)

## Publishing an update

We forgot to add a documentation string to our `.mli` file. Let's do that now:

```ocaml
(** Build a roman numeral string from an integer. *)
val roman_int_of_string : int -> string
```

Now we tag version 0.2:

```
git tag -a 0.2
git push origin 0.2
```

And run `opam-publish` again to make a PR for version 0.2 of our library.
