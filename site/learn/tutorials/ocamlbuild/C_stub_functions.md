# C stub functions
` (* Ocamlbuild plugin *)`<br />` `<br />` open Ocamlbuild_pack;;`<br />` open Ocamlbuild_plugin;;`<br />` open Command;;`<br />` open Ocaml_specific;;`<br />` open Outcome;;`<br />` `<br />` module Config32 =`<br />`   struct`<br />`     let bits64 = false;;`<br />`   end`<br />` ;;`<br />` `<br />` module Config64 =`<br />`   struct`<br />`     let bits64 = true;;`<br />`   end`<br />` ;;`<br />` `<br />` open Config64;;`<br />` `<br />` let ocaml_local_dir =`<br />`   try`<br />`     Sys.getenv "OCAMLDIR"`<br />`   with`<br />`   | Not_found -> failwith "OCAMLDIR environment variable must be set; usually that's the directory where, for instance, camlinternalMod.* reside."`<br />` ;;`<br />` `<br />` let local dir = Filename.concat ocaml_local_dir dir;;`<br />` `<br />` type libdep_description = {`<br />`   ld_name : string;`<br />`   ld_have_lib : string option;`<br />`   ld_lib : string;`<br />`   ld_dir : string;`<br />`   ld_include : string;`<br />`   ld_static : bool;`<br />`   ld_c_headers : string list`<br />` };;`<br />` `<br />` type ocaml_lib_description = {`<br />`   od_path : string;`<br />`   od_name : string;`<br />`   od_headers : string list`<br />` };;`<br />` `<br />` let system_lib_dir =`<br />`   if bits64 then`<br />`     "/usr/lib64"`<br />`   else`<br />`     "/usr/lib"`<br />` ;;`<br />` `<br />` let zlib_description = {`<br />`   ld_name = "zlib";`<br />`   ld_have_lib = Some"-DHAVE_ZLIB";`<br />`   ld_lib = "-lz";`<br />`   ld_dir = "-L"^system_lib_dir;`<br />`   ld_include = "-L/usr/include";`<br />`   ld_c_headers = [];`<br />`   ld_static = true`<br />` }`<br />` ;;`<br />` `<br />` let clibdep ld =`<br />`    (* When one makes a C library that use the zlib with ocamlmklib,`<br />`       then issue these flags. *)`<br />`    flag ["ocamlmklib"; "c"; "use_"^ld.ld_name]`<br />`         (S[A ld.ld_dir; A ld.ld_lib]);`<br />` `<br />`    (* When one compiles C code using the zlib *)`<br />`    flag ["c"; "compile"; "include_"^ld.ld_name]`<br />`         (S[A"-ccopt"; A ld.ld_include;`<br />`            begin match ld.ld_have_lib with`<br />`              | None -> N`<br />`              | Some x -> S[A"-ccopt"; A x]`<br />`            end]);`<br />` `<br />`    flag ["link"; "ocaml"; "library"; "use_"^ld.ld_name]`<br />`         (S[A"-ccopt"; A ld.ld_dir; A"-cclib"; A ld.ld_lib]);`<br />` `<br />``    (* If `static' is true then every ocaml link in bytecode will add -custom *)``<br />`    if ld.ld_static then flag ["link"; "ocaml"; "byte"] (A"-custom");`<br />` ;;`<br />` `<br />` let cryptokit_lib_description = {`<br />`   od_path = "";`<br />`   od_name = "cryptokit";`<br />`   od_headers = `<br />`     ["arcfour.h"; "d3des.h"; "rijndael-alg-fst.h";`<br />`       "ripemd160.h"; "sha1.h"; "sha256.h"]`<br />` };;`<br />` `<br />` let float32_lib_description = {`<br />`   od_path = "float32/";`<br />`   od_name = "float32";`<br />`   od_headers = []`<br />` `<br />` (* XXX : fix me *)`<br />` let ocamllib old =`<br />`    let u = old.od_name in`<br />`    (* X is an ocaml library.`<br />`       This will declare use_X and include_X *)`<br />`    ocaml_lib u;`<br />` `<br />`    flag ["link"; "library"; "ocaml"; "byte"; "use_"^u]`<br />`    (S[A"-dllpath";A(old.od_path);A"-dllib";A("-l"^u); A"-cclib";A("-L"^old.od_path);A"-cclib";A("-l"^u)]);`<br />` `<br />`    flag ["link"; "ocaml"; "byte"; "use_"^u]`<br />`    (S[A"-dllpath";A(old.od_path);A"-dllib";A("-l"^u); A"-cclib";A("-L"^old.od_path);A"-cclib";A("-l"^u)]);`<br />` `<br />`    flag ["link"; "library"; "ocaml"; "native"; "use_lib"^u]`<br />`         (S[A"-cclib";A("-L"^old.od_path);A"-cclib"; A("-l"^u)]);`<br />` `<br />`    (* When ocaml link something that use the libX`<br />`       then one need that file to be up to date. *)`<br />`    dep  ["link"; "ocaml"; "use_lib"^u] [old.od_path^"lib"^u^".a"];`<br />` `<br />`    (* As an approximation all our C files use the headers.`<br />`       Note: This will import headers in the build directory. *)`<br />`    dep  ["compile"; "c"] old.od_headers;`<br />` ;;`<br />` `<br />` dispatch`<br />`   begin function`<br />`   | After_options ->`<br />`       begin`<br />`         Options.hygiene := true;`<br />`         Options.sanitize := true;`<br />`         Options.ocamlopt := A"ocamlopt.opt";`<br />`         Options.ocamlc := A"ocamlc.opt";`<br />`         Options.ocamldep := A"ocamldep.opt";`<br />`         Options.ocamlyacc := A "menhir";`<br />`         Options.include_dirs :=`<br />`           ["graph"; "util"; "float32"; "mysubdir1"; "mysubdir2"] @ !Options.include_dirs`<br />`       end`<br />`   | After_rules ->`<br />`       begin`<br />`         List.iter`<br />`           begin fun dir ->`<br />`             flag ["ocaml"; "link"]    (S[A"-I"; A dir]);`<br />`             flag ["ocaml"; "compile"] (S[A"-I"; A dir]);`<br />`             flag ["ocaml"; "doc"]     (S[A"-I"; A dir])`<br />`           end`<br />`           [(*"+pcre";*)`<br />`            local "mysubdir1";`<br />`            local "mysubdir2"];`<br />` `<br />`         Log.dprintf 5 "Ready";`<br />`         `<br />`         ocamllib float32_lib_description;`<br />`         flag ["ocaml"; "link"; "byte"; "use_float32"] (S[A"-dllpath";A"float32";A"-dllib"; A"-lfloat32"]);*)`<br />`       end`<br />`   | _ -> ()`<br />`   end`

